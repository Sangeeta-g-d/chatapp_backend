{% extends 'admin_base.html' %}
{% load static %}
{% block content %}
 <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<div class="container mt-4">
     <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold mb-0">Email Center</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmailModal">
            <i class="fas fa-plus me-1"></i> Add New Email
        </button>
    </div>

    <!-- 🔍 Search + Filter -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div class="d-flex flex-wrap">
            <input type="text" id="searchInput" class="form-control me-2 mb-2"
                   placeholder="Search by email, employee ID or level...">
            
           <select id="levelFilter" class="form-select w-auto mb-2">
    <option value="">All Levels</option>
    {% for level in levels %}
        <option value="{{ level }}">{{ level }}</option>
    {% endfor %}
</select>
        </div>

        <!-- 📄 Rows per page -->
        <div>
            <select id="rowsPerPage" class="form-select w-auto">
                <option value="5">5 per page</option>
                <option value="10" selected>10 per page</option>
                <option value="20">20 per page</option>
            </select>
        </div>
    </div>

    <!-- 📋 Table Card -->
    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0 table-rounded" id="emailTable">
              <thead class="table-secondary">
    <tr>
        <th class="text-center">
            <input type="checkbox" id="selectAll">
        </th>
        <th>Email</th>
        <th>Employee ID</th>
        <th>Level</th>
        <th class="text-center">Can Add Story</th>
        <th class="text-center">Can Upload Feed</th>
        <th class="text-center">Can Share Media</th>
        <th class="text-center">Can Download Media</th>
        <th class="text-center">Suspended</th>
        <th class="text-center">Actions</th>
    </tr>
</thead>

<tbody>
    {% for e in emails %}
    <tr>
        <td class="text-center">
            <input type="checkbox" class="row-checkbox">
        </td>
        <td>{{ e.email }}</td>
        <td>{{ e.employee_id }}</td>
        <td>{{ e.level }}</td>
        <td class="text-center">{% if e.can_add_story %}✔{% else %}✖{% endif %}</td>
        <td class="text-center">{% if e.can_upload_feed %}✔{% else %}✖{% endif %}</td>
        <td class="text-center">{% if e.can_share_media %}✔{% else %}✖{% endif %}</td>
        <td class="text-center">{% if e.can_download_media %}✔{% else %}✖{% endif %}</td>
        <td class="text-center">{% if e.is_suspended %}✔{% else %}✖{% endif %}</td>
        <td class="text-center">
           <a href="#" 
   class="btn btn-sm btn-outline-primary me-2 edit-btn" 
   data-id="{{ e.id }}"
   data-can_add_story="{{ e.can_add_story|yesno:'1,0' }}"
   data-can_upload_feed="{{ e.can_upload_feed|yesno:'1,0' }}"
   data-can_share_media="{{ e.can_share_media|yesno:'1,0' }}"
   data-can_download_media="{{ e.can_download_media|yesno:'1,0' }}"
   data-is_suspended="{{ e.is_suspended|yesno:'1,0' }}"
   data-suspension_reason="{{ e.suspension_reason }}"
   data-suspension_until="{{ e.suspension_until|date:'Y-m-d\\TH:i' }}"
   title="Edit"
>
   <i class="fas fa-edit"></i>
</a>
            <a href="" class="btn btn-sm btn-outline-danger" title="Delete"
               onclick="return confirm('Are you sure you want to delete this record?');">
                <i class="fas fa-trash"></i>
            </a>
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="9" class="text-center text-muted">No records found</td>
    </tr>
    {% endfor %}
</tbody>


            </table>
        </div>
    </div>

    <!-- 📌 Pagination Controls -->
    <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap">
        <p class="mb-2" id="showingInfo">Showing 0 to 0 of 0 entries</p>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" id="editForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Email Permissions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="email_id" id="modalEmailId">
          
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="can_add_story" id="modalCanAddStory">
            <label class="form-check-label" for="modalCanAddStory">Can Add Story</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="can_upload_feed" id="modalCanUploadFeed">
            <label class="form-check-label" for="modalCanUploadFeed">Can Upload Feed</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="can_share_media" id="modalCanShareMedia">
            <label class="form-check-label" for="modalCanShareMedia">Can Share Media</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="can_download_media" id="modalCanDownloadMedia">
            <label class="form-check-label" for="modalCanDownloadMedia">Can Download Media</label>
          </div>
          <hr>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_suspended" id="modalIsSuspended">
            <label class="form-check-label" for="modalIsSuspended">Suspended</label>
          </div>
          <div class="mb-2">
            <label for="modalSuspensionReason" class="form-label">Suspension Reason</label>
            <input type="text" class="form-control" name="suspension_reason" id="modalSuspensionReason">
          </div>
          <div class="mb-2">
            <label for="modalSuspensionUntil" class="form-label">Suspension Until</label>
            <input type="datetime-local" class="form-control" name="suspension_until" id="modalSuspensionUntil">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", function(e) {
        e.preventDefault();

        document.getElementById("modalEmailId").value = btn.dataset.id;
        document.getElementById("modalCanAddStory").checked = btn.dataset.can_add_story === "1";
        document.getElementById("modalCanUploadFeed").checked = btn.dataset.can_upload_feed === "1";
        document.getElementById("modalCanShareMedia").checked = btn.dataset.can_share_media === "1";
        document.getElementById("modalCanDownloadMedia").checked = btn.dataset.can_download_media === "1";
        document.getElementById("modalIsSuspended").checked = btn.dataset.is_suspended === "1";
        document.getElementById("modalSuspensionReason").value = btn.dataset.suspension_reason || "";
        document.getElementById("modalSuspensionUntil").value = btn.dataset.suspension_until || "";

        var modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
    });
});
</script>
<script>
  {% if success == "updated" %}
    Toastify({
      text: "Email permissions updated successfully!",
      duration: 3000,
      gravity: "top",
      position: "right",
      backgroundColor: "#4fbe87",
    }).showToast();
  {% elif success == "added" %}
    Toastify({
      text: "New email added successfully!",
      duration: 3000,
      gravity: "top",
      position: "right",
      backgroundColor: "#4fbe87",
    }).showToast();
  {% endif %}

  // ✅ After showing toast, remove ?success=... from URL
  if (window.location.search.includes("success=")) {
      const newUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
  }
</script>


<!-- add new email -->
 <!-- Add Email Modal -->
<div class="modal fade" id="addEmailModal" tabindex="-1" aria-labelledby="addEmailModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" id="addEmailForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addEmailModalLabel">Add New Email</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="newEmail" name="email" required>
          </div>
          <div class="mb-3">
            <label for="newEmployeeId" class="form-label">Employee ID</label>
            <input type="text" class="form-control" id="newEmployeeId" name="employee_id" required>
          </div>
          <div class="mb-3">
            <label for="newLevel" class="form-label">Level</label>
            <input type="text" class="form-control" id="newLevel" name="level" required>
            
          </div>
          <hr>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="can_add_story" id="newCanAddStory">
            <label class="form-check-label" for="newCanAddStory">Can Add Story</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="can_upload_feed" id="newCanUploadFeed">
            <label class="form-check-label" for="newCanUploadFeed">Can Upload Feed</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="can_share_media" id="newCanShareMedia">
            <label class="form-check-label" for="newCanShareMedia">Can Share Media</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="can_download_media" id="newCanDownloadMedia">
            <label class="form-check-label" for="newCanDownloadMedia">Can Download Media</label>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="is_suspended" id="newIsSuspended">
            <label class="form-check-label" for="newIsSuspended">Suspended</label>
          </div>
          <div class="mb-2">
            <label for="newSuspensionReason" class="form-label">Suspension Reason</label>
            <input type="text" class="form-control" name="suspension_reason" id="newSuspensionReason">
          </div>
          <div class="mb-2">
            <label for="newSuspensionUntil" class="form-label">Suspension Until</label>
            <input type="datetime-local" class="form-control" name="suspension_until" id="newSuspensionUntil">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add Email</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ✅ FontAwesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    /* Rounded table corners */
    .table-rounded {
        border-radius: 0.6rem;
        overflow: hidden;
    }
</style>

<!-- ✅ Search + Filter + Pagination Script -->
<script>
    const table = document.getElementById("emailTable");
    const rows = table.querySelectorAll("tbody tr");
    const pagination = document.getElementById("pagination");
    const showingInfo = document.getElementById("showingInfo");

    let currentPage = 1;
    let rowsPerPage = parseInt(document.getElementById("rowsPerPage").value);

    function renderTable() {
        let searchVal = document.getElementById("searchInput").value.toLowerCase();
        let filterVal = document.getElementById("levelFilter").value.toLowerCase();

        let filteredRows = Array.from(rows).filter(row => {
            let text = row.innerText.toLowerCase();
            let level = row.cells[3]?.innerText.toLowerCase() || "";
            return text.includes(searchVal) && (!filterVal || level === filterVal);
        });

        let total = filteredRows.length;
        let totalPages = Math.ceil(total / rowsPerPage);
        if (currentPage > totalPages) currentPage = totalPages || 1;

        // Hide all rows
        rows.forEach(r => r.style.display = "none");

        // Show only paginated rows
        let start = (currentPage - 1) * rowsPerPage;
        let end = start + rowsPerPage;
        filteredRows.slice(start, end).forEach(r => r.style.display = "");

        // Update showing info
        let showingStart = total ? start + 1 : 0;
        let showingEnd = Math.min(end, total);
        showingInfo.innerText = `Showing ${showingStart} to ${showingEnd} of ${total} entries`;

        // Render pagination buttons
        pagination.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
            let li = document.createElement("li");
            li.className = "page-item " + (i === currentPage ? "active" : "");
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", function (e) {
                e.preventDefault();
                currentPage = i;
                renderTable();
            });
            pagination.appendChild(li);
        }
    }

    // ✅ Event Listeners
    document.getElementById("searchInput").addEventListener("keyup", renderTable);
    document.getElementById("levelFilter").addEventListener("change", renderTable);
    document.getElementById("rowsPerPage").addEventListener("change", function () {
        rowsPerPage = parseInt(this.value);
        currentPage = 1;
        renderTable();
    });

    // ✅ Select All Checkboxes
    document.getElementById("selectAll").addEventListener("change", function () {
        document.querySelectorAll(".row-checkbox").forEach(cb => cb.checked = this.checked);
    });

    // Initial render
    renderTable();
</script>
{% endblock %}
