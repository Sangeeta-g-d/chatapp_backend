{% extends 'admin_base.html' %}
{% load static tz %}   {# ✅ Load tz for localtime filter #}

{% block content %}
<style>
    .comments-modal-body,
    .likes-modal-body {
        max-height: 400px;
        overflow-y: auto;
    }
    .comments-modal-body::-webkit-scrollbar,
    .likes-modal-body::-webkit-scrollbar {
        width: 6px;
    }
    .comments-modal-body::-webkit-scrollbar-thumb,
    .likes-modal-body::-webkit-scrollbar-thumb {
        background: #c5c5c5;
        border-radius: 10px;
    }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0">Feeds Management</h2>
       <div class="d-flex">
    <form method="get" class="d-flex">
        <select name="level" class="form-select me-2" onchange="this.form.submit()">
            <option value="">All Levels</option>
            {% for level in levels %}
                <option value="{{ level }}" {% if selected_level == level %}selected{% endif %}>
                    {{ level }}
                </option>
            {% endfor %}
        </select>
        <noscript><button type="submit" class="btn btn-primary">Filter</button></noscript>
    </form>
</div>

    </div>

    <div class="row">
        {% for feed in feeds %}
        <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
            <div class="card shadow-sm rounded-3 h-100 feed-card">
                
                <!-- Feed Header -->
                <div class="card-header d-flex align-items-center bg-white border-0 pb-2">
                   {% if feed.user.userprofile and feed.user.userprofile.profile_picture %}
                        <img src="{{ feed.user.userprofile.profile_picture.url }}" 
                             class="rounded-circle me-2"
                             alt="User" width="40" height="40">
                   {% else %}
                        <img src="/static/assets/images/feed_user.webp" 
                             class="rounded-circle me-2"
                             alt="User" width="40" height="40">
                   {% endif %}
                    <div class="flex-grow-1">
                        <h6 class="mb-0 fw-bold text-truncate">{{ feed.user.full_name|default:feed.user.email }}</h6>
                        <small class="text-muted">{{ feed.created_at|localtime|date:"M d, Y H:i" }}</small>
                    </div>
                    <div class="dropdown">
                       <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                               id="feedDropdown{{ feed.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="feedDropdown{{ feed.id }}">
                            <li>
  <a class="dropdown-item text-danger delete-feed-btn" 
     href="#" 
     data-feed-id="{{ feed.id }}" 
     data-bs-toggle="modal" 
     data-bs-target="#deleteConfirmModal">
     <i class="bi bi-trash me-2"></i>Delete
  </a>
</li>
                        </ul>
                    </div>
                </div>

                <!-- Feed Content -->
                <div class="card-body p-0">
                    {% if feed.feed_type == "text" or feed.feed_type == "both" %}
                        <div class="p-3 pb-2">
                            <p class="feed-text">{{ feed.text|truncatewords:30 }}</p>
                            {% if feed.text|wordcount > 30 %}
                                <a href="#" class="small text-primary">Read more</a>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if feed.feed_type == "file" or feed.feed_type == "both" %}
                        {% if feed.file.url %}
                            {% if feed.file.url|lower|slice:"-4:" in ".jpg,.png,.jpeg,.gif" %}
                                <div class="feed-image-container">
                                    <img src="{{ feed.file.url }}" class="img-fluid w-100" alt="Feed Image" style="object-fit: cover; height: 250px;">
                                </div>
                            {% else %}
                                <div class="p-3">
                                  <div class="d-flex align-items-center p-3 border rounded bg-light">
                                        <i class="bi bi-file-earmark-text fs-3 text-primary me-3"></i>
                                        <div class="flex-grow-1">
                                            <p class="mb-0 fw-bold">Attached File</p>
                                            <small class="text-muted">{{ feed.file.name|slice:"5:" }}</small>
                                        </div>
                                        <a href="{{ feed.file.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Stats and Actions -->
                <div class="card-footer bg-white border-0 pt-0">
                    <div class="d-flex justify-content-between mb-2">
                        <div class="d-flex align-items-center">
                            <!-- ✅ Likes Modal Trigger -->
                            <span class="me-3">
                                <a href="#" class="text-decoration-none text-dark" data-bs-toggle="modal" data-bs-target="#likesModal{{ feed.id }}">
                                    <i class="bi bi-heart-fill text-danger me-1"></i> {{ feed.likes.count }}
                                </a>
                            </span>
                            <span>
                                <i class="bi bi-chat-left-text text-primary me-1"></i> {{ feed.comments.count }}
                            </span>
                        </div>
                        <div>
                            <span class="badge bg-secondary">{{ feed.feed_type|title }}</span>
                        </div>
                    </div>
                    
                    <div class="d-flex border-top pt-2">
                        <button class="btn btn-sm btn-outline-secondary flex-fill">
                            <i class="bi bi-eye"></i> View Details
                        </button>
                    </div>
                </div>

                <!-- Comments Preview -->
                {% if feed.comments.all %}
                <div class="px-3 pb-3">
                    <div class="comments-preview">
                        {% for comment in feed.comments.all|slice:":2" %}
                            <div class="d-flex mb-2">
                                <div class="flex-grow-1 bg-light rounded p-2">
                                    <strong class="d-block">{{ comment.user.full_name|default:comment.user.email }}</strong> 
                                    <span class="small">{{ comment.comment }}</span>
                                    <div><small class="text-muted">{{ comment.created_at|localtime|date:"M d, Y H:i" }}</small></div>
                                </div>
                            </div>
                        {% endfor %}

                        {% if feed.comments.count > 2 %}
                            <!-- Trigger Modal -->
                            <a href="#" class="small text-primary" data-bs-toggle="modal" data-bs-target="#commentsModal{{ feed.id }}">
                                View all {{ feed.comments.count }} comments
                            </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ✅ Comments Modal -->
        <div class="modal fade" id="commentsModal{{ feed.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-3">
              <div class="modal-header">
                <h5 class="modal-title">Comments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body comments-modal-body">
                {% for comment in feed.comments.all %}
                    <div class="d-flex mb-3">
                        <div class="flex-grow-1 bg-light rounded p-2">
                            <strong class="d-block">{{ comment.user.full_name|default:comment.user.email }}</strong> 
                            <span class="small">{{ comment.comment }}</span>
                            <div><small class="text-muted">{{ comment.created_at|localtime|date:"M d, Y H:i" }}</small></div>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">No comments yet.</p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ Likes Modal -->
        <div class="modal fade" id="likesModal{{ feed.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content rounded-3">
              <div class="modal-header">
                <h5 class="modal-title">Liked by</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body likes-modal-body">
                {% for like in feed.likes.all %}
                    <div class="d-flex align-items-center mb-3">
                        {% if like.user.userprofile and like.user.userprofile.profile_picture %}
                            <img src="{{ like.user.userprofile.profile_picture.url }}" 
                                 class="rounded-circle me-2"
                                 alt="User" width="40" height="40">
                        {% else %}
                            <img src="/static/assets/images/feed_user.webp" 
                                 class="rounded-circle me-2"
                                 alt="User" width="40" height="40">
                        {% endif %}
                        <div>
                            <strong class="d-block">{{ like.user.full_name|default:like.user.email }}</strong>
                            <small class="text-muted">Liked on {{ like.created_at|localtime|date:"M d, Y H:i" }}</small>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">No likes yet.</p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        {% empty %}
        <div class="col-12">
            <div class="text-center py-5 bg-light rounded-3">
                <i class="fas fa-rss fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No feeds yet</h4>
                <p class="text-muted">When users create posts, they will appear here.</p>
               
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if feeds.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if feeds.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ feeds.previous_page_number }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}
            
            {% for i in feeds.paginator.page_range %}
            <li class="page-item {% if feeds.number == i %}active{% endif %}">
                <a class="page-link" href="?page={{ i }}">{{ i }}</a>
            </li>
            {% endfor %}
            
            {% if feeds.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ feeds.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this feed? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>
<!-- delete post -->
 <!-- Toastify CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
let feedToDelete = null;

// Open modal and store feed ID
document.querySelectorAll(".delete-feed-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        feedToDelete = this.getAttribute("data-feed-id");
    });
});

// Confirm deletion
document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
    if (!feedToDelete) return;

    fetch(`/feeds/delete/${feedToDelete}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
        },
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Hide modal
            let modal = bootstrap.Modal.getInstance(document.getElementById("deleteConfirmModal"));
            modal.hide();

            // Remove feed card from UI
            const feedCard = document.querySelector(`[data-feed-id="${feedToDelete}"]`).closest(".col-xl-4");
            if (feedCard) feedCard.remove();

            // Show toast
            Toastify({
                text: "Feed deleted successfully!",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "#dc3545",
                stopOnFocus: true,
            }).showToast();
        }
    });
});

// CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
    .feed-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .feed-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1) !important;
    }
    .feed-text {
        line-height: 1.5;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
    }
    .feed-image-container {
        overflow: hidden;
        border-radius: 0 0 0.5rem 0.5rem;
    }
    .comments-preview {
        max-height: 200px;
        overflow-y: auto;
    }
    .comments-preview::-webkit-scrollbar {
        width: 5px;
    }
    .comments-preview::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    .comments-preview::-webkit-scrollbar-thumb {
        background: #c5c5c5;
        border-radius: 10px;
    }
</style>
{% endblock %}
